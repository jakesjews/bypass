# Local Medplum full stack (dev)
#
# This is based on Medplum's official full-stack Docker Compose file:
# https://www.medplum.com/docs/self-hosting/running-full-medplum-stack-in-docker
#
# We keep it at repo root for simplicity.
#
# Note on ports:
# - We map Medplum App (admin UI) to 3005 to avoid colliding with medplum-chart-demo (often 3000).
#
services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_USER=medplum
      - POSTGRES_PASSWORD=medplum
    volumes:
      - medplum-postgres-data:/var/lib/postgresql/data
    command:
      - 'postgres'
      - '-c'
      - 'listen_addresses=*'
      - '-c'
      - 'statement_timeout=60000'
      - '-c'
      - 'default_transaction_isolation=REPEATABLE READ'
      - '-c'
      - 'shared_preload_libraries=pg_stat_statements,auto_explain'
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U medplum']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    restart: unless-stopped
    command: redis-server --requirepass medplum
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', 'medplum', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  medplum-server:
    image: medplum/medplum-server:latest
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '8103:8103'
    command: ['env']
    environment:
      MEDPLUM_PORT: 8103
      MEDPLUM_BASE_URL: 'http://localhost:8103/'
      # IMPORTANT: This is the Medplum App (admin UI) base URL.
      # Your product app is separate (chart-demo baseline).
      MEDPLUM_APP_BASE_URL: 'http://localhost:3005/'
      MEDPLUM_STORAGE_BASE_URL: 'http://localhost:8103/storage/'

      MEDPLUM_DATABASE_HOST: 'postgres'
      MEDPLUM_DATABASE_PORT: 5432
      MEDPLUM_DATABASE_DBNAME: 'medplum'
      MEDPLUM_DATABASE_USERNAME: 'medplum'
      MEDPLUM_DATABASE_PASSWORD: 'medplum'

      MEDPLUM_REDIS_HOST: 'redis'
      MEDPLUM_REDIS_PORT: 6379
      MEDPLUM_REDIS_PASSWORD: 'medplum'

      MEDPLUM_BINARY_STORAGE: 'file:./binary/'

      # Dev/test-only convenience: allow all origins to avoid local port friction.
      MEDPLUM_ALLOWED_ORIGINS: '*'
      MEDPLUM_DEFAULT_SUPER_ADMIN_EMAIL: 'bypass@bypass.com'
      MEDPLUM_DEFAULT_SUPER_ADMIN_PASSWORD: 'bypass123'
      MEDPLUM_REGISTER_ENABLED: 'false'
      MEDPLUM_DEFAULT_O_AUTH_CLIENTS: '[{"resourceType":"ClientApplication","id":"9f8f3f84-0fbe-4f8e-a7f4-7f6a26b7f8aa","name":"Bypass Local Client","redirectUris":["http://localhost:3000/","http://localhost:5173/"],"pkceOptional":true}]'

      MEDPLUM_INTROSPECTION_ENABLED: 'true'
      MEDPLUM_VM_CONTEXT_BOTS_ENABLED: 'true'
      MEDPLUM_DEFAULT_BOT_RUNTIME_VERSION: 'vmcontext'
      MEDPLUM_SHUTDOWN_TIMEOUT_MILLISECONDS: 30000

    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          'fetch("http://localhost:8103/healthcheck").then(r => r.json()).then(console.log).catch(() => { process.exit(1); })',
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  medplum-app:
    image: medplum/medplum-app:latest
    restart: unless-stopped
    depends_on:
      medplum-server:
        condition: service_healthy
    ports:
      - '3005:3000'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  medplum-postgres-data:
